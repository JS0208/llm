<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì§ì—… ì‹œë®¬ë ˆì´ì…˜ Pro (ìˆ˜ì • ë²„ì „)</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; }
        .fade-in { animation: a-fade-in 0.5s ease-out forwards; }
        .fade-out { animation: a-fade-out 0.3s ease-in forwards; }
        .message-bubble-in { animation: a-message-bubble-in 0.4s ease-out forwards; }
        @keyframes a-fade-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes a-fade-out { from { opacity: 1; } to { opacity: 0; } }
        @keyframes a-message-bubble-in { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .loading-dots span { animation: a-dot-pulse 1.4s infinite; display: inline-block; opacity: 0; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes a-dot-pulse { 0%, 100% { opacity: 0; } 50% { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-100 flex justify-center items-center h-screen p-4">

    <div id="app-container" class="w-full max-w-lg h-full bg-white flex flex-col shadow-2xl rounded-2xl overflow-hidden ring-1 ring-gray-900/5">

        <!-- í™”ë©´ 1: ì‹œë‚˜ë¦¬ì˜¤ ì„ íƒ -->
        <div id="selection-screen" class="flex flex-col h-full">
            <header class="bg-gradient-to-r from-gray-800 to-gray-900 text-white p-5 flex-shrink-0 shadow-lg">
                <h1 class="text-2xl font-bold text-center">ì§ì—… ì‹œë®¬ë ˆì´ì…˜ Pro</h1>
                <p class="text-center text-sm text-gray-300 mt-1">ì²´í—˜í•  ì§ì—…ì„ ì„ íƒí•˜ì„¸ìš”.</p>
            </header>
            <main id="scenario-list" class="flex-grow p-3 sm:p-5 overflow-y-auto bg-gray-50 space-y-3"></main>
        </div>

        <!-- í™”ë©´ 2: ì‹œë®¬ë ˆì´ì…˜ (ì±„íŒ…) -->
        <div id="simulation-screen" class="hidden flex-col h-full">
            <header id="simulation-header" class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 flex-shrink-0 flex items-center shadow-md">
                <button id="back-to-selection" class="p-2 mr-2 rounded-full hover:bg-white/20 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
                </button>
                <h1 id="simulation-title" class="text-xl font-bold text-center flex-grow"></h1>
                <div class="w-10"></div>
            </header>
            <main id="chat-window" class="flex-grow p-4 overflow-y-auto bg-white"></main>
            <footer class="flex-shrink-0 p-3 bg-gray-50 border-t">
                <div id="hint-buttons-container" class="flex flex-wrap justify-center gap-2 mb-2"></div>
                <form id="message-form" class="flex items-center space-x-3">
                    <button type="button" id="show-hints-button" title="ì¶”ì²œ ë‹µë³€ ë³´ê¸°" class="p-3 border rounded-full hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-yellow-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 017.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                        </svg>
                    </button>
                    <input type="text" id="message-input" placeholder="ì–´ë–»ê²Œ í–‰ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?" class="flex-grow p-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 transition-shadow" autocomplete="off">
                    <button type="submit" id="submit-button" class="bg-blue-600 text-white rounded-full p-3 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-300 transform hover:scale-110">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </form>
            </footer>
        </div>

        <!-- í™”ë©´ 3: ì„±í–¥ ë¶„ì„ ê²°ê³¼ -->
        <div id="analysis-screen" class="hidden flex-col h-full">
            <header class="bg-gradient-to-r from-purple-600 to-indigo-700 text-white p-4 flex-shrink-0 shadow-md">
                <h1 class="text-xl font-bold text-center w-full">í”Œë ˆì´ì–´ ì„±í–¥ ë¶„ì„ ê²°ê³¼</h1>
            </header>
            <main class="flex-grow p-4 overflow-y-auto bg-white space-y-4">
                <h2 id="analysis-summary" class="text-center text-lg font-semibold"></h2>
                <canvas id="analysis-chart" class="w-full max-w-md mx-auto"></canvas>
                <ul id="analysis-desc" class="text-sm space-y-1"></ul>
            </main>
            <footer class="flex-shrink-0 p-3 bg-gray-50 border-t">
                <button id="analysis-back" class="w-full bg-gray-800 text-white py-3 rounded-xl font-semibold hover:bg-gray-900 transition-transform transform hover:scale-105">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
            </footer>
        </div>
    </div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        try {
            // DOM ìš”ì†Œ ìºì‹±
            const selectionScreen = document.getElementById('selection-screen');
            const simulationScreen = document.getElementById('simulation-screen');
            const analysisScreen = document.getElementById('analysis-screen');
            const scenarioList = document.getElementById('scenario-list');
            const chatWindow = document.getElementById('chat-window');
            const messageForm = document.getElementById('message-form');
            const messageInput = document.getElementById('message-input');
            const simulationTitle = document.getElementById('simulation-title');
            const backButton = document.getElementById('back-to-selection');
            const analysisBackButton = document.getElementById('analysis-back');
            const submitButton = document.getElementById('submit-button');
            const hintButtonsContainer = document.getElementById('hint-buttons-container');
            const showHintsButton = document.getElementById('show-hints-button');
            const analysisSummary = document.getElementById('analysis-summary');
            const analysisChartCanvas = document.getElementById('analysis-chart');
            const analysisDesc = document.getElementById('analysis-desc');

            const API_KEY = "AIzaSyCztDXmWRRAiyjRPaWNRLaKGltDKUdJ0YA"; 
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${API_KEY}`;

            const SYSTEM_PROMPT = `ë‹¹ì‹ ì€ í”Œë ˆì´ì–´ì˜ ì§ì—… ë¼ì´í”„ë¥¼ í•œ í¸ì˜ í¥ë¯¸ì§„ì§„í•œ ë“œë¼ë§ˆë¡œ ë§Œë“œëŠ” 'ê²Œì„ ë§ˆìŠ¤í„°'ì…ë‹ˆë‹¤. ë‹¹ì‹ ì˜ ë¯¸ì…˜ì€ í”Œë ˆì´ì–´ì˜ ì„ íƒì´ ì–´ë–¤ íŒŒë€ë§Œì¥í•œ ê²°ê³¼ë¥¼ ë‚³ì„ì§€, ê°€ì¥ í¥ë¯¸ë¡œìš´ ë‹¤ìŒ ìƒí™©ì„ ì—°ì¶œí•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

[ê²Œì„ ì§„í–‰ ê°€ì´ë“œ]
1.  **ë‚˜ë¹„íš¨ê³¼**: ë‹¹ì‹ ì˜ ì‘ë‹µì€ í”Œë ˆì´ì–´ì˜ í–‰ë™ì´ ì¼ìœ¼í‚¨ ì§œë¦¿í•œ 'ê²°ê³¼'ì—¬ì•¼ í•©ë‹ˆë‹¤. ê³¼ì • ì„¤ëª…ì€ ìƒëµí•˜ê³ , í–‰ë™ì˜ ê²°ê³¼ë¥¼ ë³´ì—¬ì£¼ì„¸ìš”.
2.  **ë˜˜ë¼ ì¡´ì¤‘**: ì—‰ëš±í•˜ê³  ê¸°ë°œí•œ ì•„ì´ë””ì–´? ëŒ€í™˜ì˜ì…ë‹ˆë‹¤! ìŠ¤í† ë¦¬ê°€ ì‚°ìœ¼ë¡œ ê°€ì§€ ì•ŠëŠ” ì„ ì—ì„œ, í”Œë ˆì´ì–´ì˜ ì°½ì˜ì ì¸ í•´ê²°ì±…ì„ ì ê·¹ ìˆ˜ìš©í•˜ê³  ê·¸ì— ë”°ë¥¸ ìƒˆë¡œìš´ ë”œë ˆë§ˆë¥¼ ë˜ì ¸ì£¼ì„¸ìš”.
3.  **ì‹œë ¨ì€ ì…€í”„**: ì •ë‹µì„ ì•Œë ¤ì£¼ê±°ë‚˜ ë¬¸ì œë¥¼ ëŒ€ì‹  í•´ê²°í•´ì£¼ì§€ ë§ˆì„¸ìš”. í”Œë ˆì´ì–´ë¥¼ ë”ìš± ì„±ì¥ì‹œí‚¬ ìƒˆë¡œìš´ ë„ì „ê³¼ì œë‚˜ ì˜ˆìƒì¹˜ ëª»í•œ ìœ„ê¸°ë¥¼ ì„ ë¬¼í•´ì•¼ í•©ë‹ˆë‹¤.
4.  **í´ë¼ì´ë§¥ìŠ¤**: í”Œë ˆì´ì–´ì˜ ì„ íƒì´ 3~4ë²ˆ ìŒ“ì´ë©´, ê·¸ë™ì•ˆì˜ í–‰ë™ì´ ì–´ë–¤ ê²°ê³¼ë¥¼ ë‚³ì•˜ëŠ”ì§€ ë³´ì—¬ì£¼ëŠ” í´ë¼ì´ë§¥ìŠ¤ë¥¼ ì—°ì¶œí•˜ì„¸ìš”. ì„±ê³µê³¼ ì‹¤íŒ¨ì˜ ë¶„ê¸°ì ì„ ëª…í™•íˆ ì œì‹œí•´ì•¼ í•©ë‹ˆë‹¤.
5.  **ì„íŒ©íŠ¸**: ëª¨ë“  ìƒí™©ì€ ê°•ë ¬í•˜ê²Œ ë‘ ë¬¸ì¥ìœ¼ë¡œë§Œ ìš”ì•½ë©ë‹ˆë‹¤. ê¸´ ì„¤ëª…ì€ ì§€ë£¨í•  ë¿ì´ì£ .
6.  **í•„ìˆ˜ ì„ íƒì§€**: ê° ì‘ë‹µì˜ ë§ˆì§€ë§‰ì—ëŠ” ë°˜ë“œì‹œ [íŒíŠ¸] íƒœê·¸ì™€ í•¨ê»˜, í”Œë ˆì´ì–´ê°€ ë‹¤ìŒì— ì·¨í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ í–‰ë™ ì„ íƒì§€ 2ê°œë¥¼ ì œì‹œí•´ì•¼ í•©ë‹ˆë‹¤. (ì˜ˆ: [íŒíŠ¸] 1. ìƒˆë¡œìš´ ì¦ê±°ë¥¼ ë¶„ì„í•œë‹¤. 2. ì¦ì¸ê³¼ ë‹¤ì‹œ ëŒ€í™”í•œë‹¤.)
7.  **í”¼ë‚ ë ˆ**: ì´ì•¼ê¸°ê°€ ëë‚¬ë‹¤ê³  íŒë‹¨ë˜ë©´, 6ë²ˆ ê·œì¹™ì˜ [íŒíŠ¸] ëŒ€ì‹  ê²°ë§ì„ ì„ ì–¸í•´ì•¼ í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ì„¤ëª… ì—†ì´ [ì—”ë”©:í•´í”¼], [ì—”ë”©:ìƒˆë“œ], [ì—”ë”©:ì˜ì˜] ì¤‘ í•˜ë‚˜ë§Œ í¬í•¨í•˜ì—¬ ì‘ë‹µì„ ë§ˆë¬´ë¦¬í•˜ì„¸ìš”.`

            const ANALYSIS_PROMPT = `[CONTEXT]
The following is a transcript from a fictional job simulation game. The user's actions are part of a role-playing scenario.

[TASK]
Based on the user's actions in the game transcript, classify the user's problem-solving patterns according to the 6 metrics below.

[METRICS]
* ë¶„ì„ë ¥ (Analysis): Logical reasoning, information gathering, evidence-based approach.
* ì°½ì˜ì„± (Creativity): Proposing unconventional or clever solutions.
* ê²°ë‹¨ë ¥ (Decisiveness): Making quick and firm decisions.
* ê³µê°ë ¥ (Empathy): Considering others' perspectives, persuading, or comforting.
* ì‹ ì¤‘í•¨ (Prudence): Checking for risks, predicting consequences, careful planning.
* ì£¼ë„ì„± (Initiative): Taking control, giving clear instructions, leading the situation.

[INSTRUCTIONS]
1. Review all 'user' role responses in the provided transcript.
2. Score each metric on a scale of 1 to 10 based on the user's demonstrated behaviors.
3. Wrap the final JSON object in a markdown code block. You may add a brief explanation before the JSON block if necessary.

[OUTPUT FORMAT]
{
  "ë¶„ì„ë ¥": <integer from 1 to 10>,
  "ì°½ì˜ì„±": <integer from 1 to 10>,
  "ê²°ë‹¨ë ¥": <integer from 1 to 10>,
  "ê³µê°ë ¥": <integer from 1 to 10>,
  "ì‹ ì¤‘í•¨": <integer from 1 to 10>,
  "ì£¼ë„ì„±": <integer from 1 to 10>
}`;

            const TRAIT_DESCRIPTIONS = {
                'ë¶„ì„ë ¥': 'ë‹¹ì‹ ì€ ê°ë³´ë‹¤ ë°ì´í„°ë¥¼, ì¶”ì¸¡ë³´ë‹¤ ëª…í™•í•œ ê·¼ê±°ë¥¼ ì‹ ë¢°í•˜ëŠ”êµ°ìš”. ë¬¸ì œì˜ í•µì‹¬ì„ ê¿°ëš«ì–´ ë³´ëŠ” ëŠ¥ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.',
                'ì°½ì˜ì„±': 'ì •í•´ì§„ ê¸¸ì„ ë”°ë¥´ê¸°ë³´ë‹¤ ìì‹ ë§Œì˜ ê¸¸ì„ ê°œì²™í•˜ëŠ” ê²ƒì„ ì¦ê¸°ëŠ”êµ°ìš”. ë‹¹ì‹ ì˜ ê¸°ë°œí•¨ì€ ë§‰ë‹¤ë¥¸ ê¸¸ì„ ìƒˆë¡œìš´ ê¸°íšŒë¡œ ë§Œë“­ë‹ˆë‹¤.',
                'ê²°ë‹¨ë ¥': 'ê³ ë¯¼ì€ ì§§ê²Œ, í–‰ë™ì€ ê³¼ê°í•˜ê²Œ! ë‹¹ì‹ ì˜ ì‹ ì†í•œ íŒë‹¨ë ¥ì€ ìœ„ê¸° ìƒí™©ì—ì„œ íŠ¹íˆ ë¹›ì„ ë°œí•©ë‹ˆë‹¤.',
                'ê³µê°ë ¥': 'ë‹¹ì‹ ì€ ì‚¬ëŒì˜ ë§ˆìŒì„ ì›€ì§ì´ëŠ” í˜ì„ ì•Œê³  ìˆìŠµë‹ˆë‹¤. ë…¼ë¦¬ë§Œìœ¼ë¡œëŠ” í•´ê²°í•  ìˆ˜ ì—†ëŠ” ë¬¸ì œë¥¼ í‘¸ëŠ” ì—´ì‡ ë¥¼ ì¥ê³  ìˆêµ°ìš”.',
                'ì‹ ì¤‘í•¨': 'ëŒë‹¤ë¦¬ë„ ë‘ë“¤ê²¨ ë³´ê³  ê±´ë„ˆëŠ” ë‹¹ì‹ ì˜ ì‹ ì¤‘í•¨ì€ ì¹˜ëª…ì ì¸ ì‹¤ìˆ˜ë¥¼ ë°©ì§€í•˜ëŠ” ê°€ì¥ ê°•ë ¥í•œ ë¬´ê¸°ì…ë‹ˆë‹¤.',
                'ì£¼ë„ì„±': 'ë‹¹ì‹ ì€ ë°©ê´€ìê°€ ì•„ë‹Œ ì§€íœ˜ìê°€ ë˜ëŠ” ê²ƒì„ ì„ íƒí•˜ëŠ”êµ°ìš”. ëª…í™•í•œ ëª©í‘œë¥¼ í–¥í•´ ì£¼ë³€ì„ ì´ë„ëŠ” í˜ì´ ìˆìŠµë‹ˆë‹¤.'
            };
            let conversationHistory = [];
            let currentHints = [];
            let currentScenario = null;
            let isGameEnded = false;
            let analysisChartInstance = null;

            // ì‹œë‚˜ë¦¬ì˜¤ ë°ì´í„° (ê¸°ì¡´ê³¼ ë™ì¼)
            const scenarios = [
                {
                    id: `chef`,
                    title: `â˜…ìŠ¤íƒ€ ì…°í”„ì˜ ì¹¨ê³µâ˜…`,
                    description: `ì € ëª…ì„±ë§Œ ë¯¿ê³  ë“¤ì–´ì˜¨ ìŠ¤íƒ€ ì…°í”„ ë•Œë¬¸ì—, ë‚´ ê°€ê²Œ ë‹¨ê³¨ë“¤ì´ í•˜ë‚˜ë‘˜ ë– ë‚˜ê°‘ë‹ˆë‹¤. ì´ëŒ€ë¡œ ê°€ê²Œë¥¼ ëºê¸¸ ìˆœ ì—†ì£ !`,
                    initialPrompt: `ë‹¹ì‹ ì€ ì‘ì€ ë™ë„¤ ë§›ì§‘ 'ë¼ ë£¨ë‚˜'ì˜ ì˜¤ë„ˆ ì…°í”„, ë°•ì„ ìš°ì…ë‹ˆë‹¤. ê·¸ëŸ°ë° í•˜í•„ ê¸¸ ê±´ë„ˆí¸ì— TV ìŠ¤íƒ€ ì…°í”„ 'ì—ë“œì›Œë“œ ê°•'ì´ ë²ˆì©ì´ëŠ” ë ˆìŠ¤í† ë‘ì„ ì—´ì—ˆìŠµë‹ˆë‹¤. íŒŒë¦¬ ë‚ ë¦¬ë˜ ê°€ê²Œì— ì´ì œëŠ” ê±°ë¯¸ì¤„ ì¹  ê¸°ì„¸, ì´ ìœ„ê¸°ë¥¼ ì–´ë–»ê²Œ ëŒíŒŒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v13m0-13V6a2 2 0 112 2h-2zm0 0V5.5A2.5 2.5 0 109.5 8H12zm-7 4h14M5 12a2 2 0 110-4h14a2 2 0 110 4M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7" /></svg>`,
                    imageUrl: `https://images.unsplash.com/photo-1555243896-c709bfa0b564?q=80&w=1200&auto=format&fit=crop`,
                    initialHints: [`ì£¼ë³€ ìƒì¸ë“¤ì˜ ë°˜ì‘ì„ ì‚´í•€ë‹¤.`, `ìš°ë¦¬ ì‹ë‹¹ë§Œì˜ í•„ì‚´ê¸° ë©”ë‰´ë¥¼ ê°œë°œí•œë‹¤.`],
                    endings: {
                        'í•´í”¼': `ëŒ€ê²°ì€ ì™„ë²½í•œ í•´í”¼ì—”ë”©! ë‹¹ì‹ ì˜ ëšì‹¬ê³¼ ì°½ì˜ë ¥ì— ë¼ì´ë²Œ ì…°í”„ë„ ë‘ ì† ë“¤ì—ˆìŠµë‹ˆë‹¤. ì´ì œ ë‘ ê°€ê²ŒëŠ” ì„œë¡œë¥¼ ì„±ì¥ì‹œí‚¤ëŠ” ë™ë„¤ì˜ ìë‘ê±°ë¦¬ê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                        'ìƒˆë“œ': `ìŠ¤íƒ€ ì…°í”„ì˜ ë²½ì€ ë†’ì•˜ìŠµë‹ˆë‹¤. ê²°êµ­ í…… ë¹ˆ ê°€ê²Œë¥¼ ë³´ë©° ì“¸ì“¸íˆ ì•ì¹˜ë§ˆë¥¼ í’€ì–´ì•¼ í–ˆìŠµë‹ˆë‹¤. ê¿ˆì€ ë•Œë¡œ í˜„ì‹¤ ì•ì—ì„œ ì ‘ì–´ì•¼ í•  ë•Œë„ ìˆëŠ” ë²•ì´ì£ .`,
                        'ì˜ì˜': `ì‹ ë©”ë‰´ ë•ì— ë‹¨ê³¨ ëª‡ëª‡ì€ ëŒì•„ì™”ì§€ë§Œ, ì—¬ì „íˆ ì €ìª½ì€ ë¬¸ì „ì„±ì‹œ. ê°€ê²Œë¥¼ ì§€ì¼œë‚¸ ê±´ ë‹¤í–‰ì´ì§€ë§Œ, ì´ ì•„ìŠ¬ì•„ìŠ¬í•œ ì¤„íƒ€ê¸°ëŠ” ì–¸ì œê¹Œì§€ ê³„ì†ë ê¹Œìš”?`
                    }
                },
                {
                    id: `paramedic`,
                    title: `ì•„ìˆ˜ë¼ì¥ ì†, ìš¸ë¦¬ëŠ” ì‚¬ì´ë Œ`,
                    description: `ë‹¹ì‹ ì€ ì•„ìˆ˜ë¼ì¥ì´ ëœ ëŒ€í˜• ì‚¬ê³  í˜„ì¥ì˜ ì²« ë²ˆì§¸ êµ¬ê¸‰ëŒ€ì›. ì¶”ê°€ ì§€ì›ê¹Œì§€ 10ë¶„, ìˆ˜ë§ì€ ìƒëª…ì´ ë‹¹ì‹ ì˜ ì†ì— ë‹¬ë ¸ìŠµë‹ˆë‹¤.`,
                    initialPrompt: `ë‹¹ì‹ ì€ 119 êµ¬ê¸‰ëŒ€ì› ê¹€ë¯¼ì¤€, ë¬´ì „ì´ ë‹¤ê¸‰í•˜ê²Œ ìš¸ë¦½ë‹ˆë‹¤. ëŒ€í˜• ì¶”ëŒì‚¬ê³  í˜„ì¥ì— ê°€ì¥ ë¨¼ì € ë„ì°©í•˜ë‹ˆ, ì—¬ê¸°ì €ê¸°ì„œ ê³ í†µìŠ¤ëŸ¬ìš´ ì‹ ìŒì´ í„°ì ¸ ë‚˜ì˜¤ê³  í•œ ì°¨ëŸ‰ì—ì„  ì—°ê¸°ê°€ í”¼ì–´ì˜¤ë¦…ë‹ˆë‹¤. ì§€ì›íŒ€ ë„ì°©ê¹Œì§€ ë‚¨ì€ 10ë¶„, ê³¨ë“ íƒ€ì„ì„ ì–´ë–»ê²Œ ì§€ì¼œë‚´ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-500" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>`,
                    imageUrl: `https://images.unsplash.com/photo-1713623311317-d3c43a4be4cf?q=80&w=1674&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D`,
                    initialHints: [`í˜„ì¥ ìƒí™©ì„ ì¦‰ì‹œ ì§€íœ˜ ë³¸ë¶€ì— ë³´ê³ í•œë‹¤.`, `ê°€ì¥ ìœ„ê¸‰í•´ ë³´ì´ëŠ” ë¶€ìƒìì—ê²Œ ë¨¼ì € ë‹¤ê°€ê°„ë‹¤.`],
                    endings: {
                        'í•´í”¼': `ì™„ë²½í•œ ê³¨ë“ íƒ€ì„ í™•ë³´! ë‹¹ì‹ ì˜ ì¹¨ì°©í•˜ê³  ì •í™•í•œ íŒë‹¨ì´ ìˆ˜ë§ì€ ìƒëª…ì„ êµ¬í–ˆìŠµë‹ˆë‹¤. ë™ë£Œë“¤ì˜ ì°¬ì‚¬ê°€ ìŸì•„ì§€ëŠ” ê°€ìš´ë°, ë‹¹ì‹ ì€ ì§„ì •í•œ ì˜ì›…ì´ ë˜ì—ˆìŠµë‹ˆë‹¤.`,
                        'ìƒˆë“œ': `í˜¼ëˆ ì†ì—ì„œ íŒë‹¨ì˜ ë¬´ê²ŒëŠ” ë„ˆë¬´ë‚˜ ë¬´ê±°ì› ìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ìµœì„ ì—ë„ ë¶ˆêµ¬í•˜ê³ , ì¼ë¶€ ë¶€ìƒìì˜ ìƒíƒœê°€ ì•…í™”ë˜ëŠ” ê²ƒì„ ë§‰ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ë¬´ë ¥ê°ê³¼ ì•ˆíƒ€ê¹Œì›€ì´ ì–´ê¹¨ë¥¼ ì§“ëˆ„ë¦…ë‹ˆë‹¤.`,
                        'ì˜ì˜': `ìµœì•…ì€ ë§‰ì•˜ì§€ë§Œ, ìµœê³ ëŠ” ë˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ëª‡ëª‡ì„ êµ¬í•˜ëŠ” ì‚¬ì´ ë‹¤ë¥¸ ë¶€ìƒìë“¤ì˜ ê³¨ë“ íƒ€ì„ì´ í˜ëŸ¬ê°”ìŠµë‹ˆë‹¤. ì§€ì›íŒ€ ë•ì— ìƒí™©ì€ ìˆ˜ìŠµëì§€ë§Œ, 'ë§Œì•½'ì´ë¼ëŠ” ì•„ì‰¬ì›€ì´ ë¨¸ë¦¿ì†ì„ ë– ë‚˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`
                    }
                },
                {
                    id: `lawyer`,
                    title: `ìŠ¤ëª¨í‚¹ ê±´, ì¡°ì‘ëœ ì§„ì‹¤?`,
                    description: `ëˆ„ê°€ ë´ë„ ì–µìš¸í•œ ë‚´ ì˜ë¢°ì¸. ê·¸ëŸ°ë° ê·¸ì˜ ì§€ë¬¸ì´ ë¬»ì€ ë²”í–‰ ë„êµ¬ê°€ ê²°ì •ì  ì¦ê±°ë¡œ ë‚˜ì™”ìŠµë‹ˆë‹¤. ë‚¨ì€ ì‹œê°„ì€ ë‹¨ í•˜ë£¨!`,
                    initialPrompt: `ë‹¹ì‹ ì€ ìŠ¹ë¥  99%ì˜ í˜•ì‚¬ ì „ë¬¸ ë³€í˜¸ì‚¬, ì´í•˜ì€ì…ë‹ˆë‹¤. ì´ë²ˆì—” ì–µìš¸í•˜ê²Œ ì ˆë„ë²”ìœ¼ë¡œ ëª°ë¦° ì²­ë…„ì„ ë³€í˜¸í•˜ê³  ìˆì£ . ê·¸ì˜ ë¬´ì£„ë¥¼ í™•ì‹ í–ˆì§€ë§Œ, ë°©ê¸ˆ ê²€ì°°ì´ ì˜ë¢°ì¸ì˜ ì§€ë¬¸ì´ ë¬»ì€ ì¹¼ì„ 'ìŠ¤ëª¨í‚¹ ê±´'ìœ¼ë¡œ ì œì¶œí–ˆìŠµë‹ˆë‹¤. ì˜ë¢°ì¸ì€ ì ˆë§í–ˆê³ , ì¬íŒì€ ë°”ë¡œ ë‚´ì¼ì…ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì–´ë–»ê²Œ ì´ íŒì„ ë’¤ì§‘ìœ¼ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l-6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2" /></svg>`,
                    imageUrl: `https://plus.unsplash.com/premium_photo-1698084059560-9a53de7b816b?q=80&w=1711&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D`,
                    initialHints: [`ì¦ê±°ê°€ ì¡°ì‘ë˜ì—ˆì„ ê°€ëŠ¥ì„±ì„ ì œê¸°í•œë‹¤.`, `ì˜ë¢°ì¸ì„ ë§Œë‚˜ ë‹¤ì‹œ í•œë²ˆ ìƒí™©ì„ ë“¤ì–´ë³¸ë‹¤.`],
                    endings: {
                        'í•´í”¼': `"ì´ì˜ ìˆìŠµë‹ˆë‹¤!" ë‹¹ì‹ ì˜ ëˆì§ˆê¸´ ì¶”ì ì´ ê²°ì •ì  ì¦ê±°ê°€ ì¡°ì‘ë˜ì—ˆìŒì„ ë°í˜€ëƒˆìŠµë‹ˆë‹¤. ë²•ì •ì—ì„œ í¼ì³ì§„ ëŒ€ì—­ì „ê·¹ìœ¼ë¡œ, ë‹¹ì‹ ì€ ì˜ë¢°ì¸ì˜ ëˆ„ëª…ì„ ì™„ë²½íˆ ë²—ê²¼ìŠµë‹ˆë‹¤.`,
                        'ìƒˆë“œ': `ê²°ì •ì ì¸ ì¦ê±°ë¥¼ ë’¤ì§‘ì§€ ëª»í•œ ì±„, ì˜ë¢°ì¸ì—ê²Œ ìœ ì£„ê°€ ì„ ê³ ë˜ì—ˆìŠµë‹ˆë‹¤. ë²•ì •ì„ ë‚˜ì„œë©°, ë³€í˜¸ì‚¬ë¡œì„œì˜ ê¹Šì€ ë¬´ë ¥ê°ê³¼ íŒ¨ë°°ê°ì„ ëŠë‚ë‹ˆë‹¤.`,
                        'ì˜ì˜': `ì¦ê±°ì˜ í—ˆì ì„ íŒŒê³ ë“¤ì–´ 'í•©ë¦¬ì  ì˜ì‹¬'ì„ ì´ëŒì–´ë‚´ëŠ” ë° ì„±ê³µí–ˆìŠµë‹ˆë‹¤. ë¬´ì£„ëŠ” ì•„ë‹ˆì§€ë§Œ, ê°í˜•ì„ ë°›ì•„ë‚´ë©° ìµœì•…ì˜ ìƒí™©ì€ í”¼í–ˆìŠµë‹ˆë‹¤.`
                    }
                },
                {
                    id: `teacher`,
                    title: `ìš°ë¦¬ ë°˜ì— ë¬´ìŠ¨ ì¼ì´?`,
                    description: `ì¡°ìš©í•˜ë˜ ìš°ë¦¬ ë°˜ì—ì„œ ë”°ëŒë¦¼ì´ ì¼ì–´ë‚˜ê³  ìˆìŠµë‹ˆë‹¤. ì„£ë¶ˆë¦¬ ê°œì…í•˜ë©´ ë¬¸ì œëŠ” ë” ì»¤ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.`,
                    initialPrompt: `ë‹¹ì‹ ì€ ì´ˆë“±í•™êµ 3í•™ë…„ 2ë°˜ ë‹´ì„, ì •ë‹¤ì†œì…ë‹ˆë‹¤. ì‰¬ëŠ” ì‹œê°„, í•œ ì•„ì´ê°€ ìš¸ë©´ì„œ ì°¾ì•„ì™€ ì¹œêµ¬ë“¤ì´ ìì‹ ì„ ë†€ë¦¬ê³  ë¼ì›Œì£¼ì§€ ì•ŠëŠ”ë‹¤ê³  ê³ ë°±í–ˆìŠµë‹ˆë‹¤. ì£¼ë™ìë¡œ ì§€ëª©ëœ ì•„ì´ë“¤ì€ í‰ì†Œì—” ê·¸ì € í•´ë§‘ë˜ ì•„ì´ë“¤ì…ë‹ˆë‹¤. ì´ ì‘ì€ ì‚¬íšŒì˜ ê°ˆë“±ì„ ì–´ë–»ê²Œ í•´ê²°í•´ì•¼ í• ê¹Œìš”?`,
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
                    imageUrl: `https://images.unsplash.com/photo-1588075592446-265fd1e6e76f?q=80&w=1200&auto=format&fit=crop`,
                    initialHints: [`ë‹¤ë¥¸ í•™ìƒë“¤ì˜ ì¦ì–¸ì„ ì¡°ìš©íˆ í™•ë³´í•œë‹¤.`, `ê°€í•´ í•™ìƒê³¼ í”¼í•´ í•™ìƒì„ ë”°ë¡œë”°ë¡œ ìƒë‹´í•œë‹¤.`],
                    endings: {
                        'í•´í”¼': `ë‹¹ì‹ ì˜ ì„¸ì‹¬í•œ ë…¸ë ¥ìœ¼ë¡œ ì•„ì´ë“¤ì€ ì„œë¡œì˜ ë§ˆìŒì„ ì´í•´í•˜ê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. êµì‹¤ì—ëŠ” ë‹¤ì‹œ ì›ƒìŒê½ƒì´ í”¼ì—ˆê³ , ì•„ì´ë“¤ì€ í•¨ê»˜ ì„±ì¥í–ˆìŠµë‹ˆë‹¤.`,
                        'ìƒˆë“œ': `ì„£ë¶€ë¥¸ í›ˆê³„ëŠ” ì˜¤íˆë ¤ ì•„ì´ë“¤ì˜ ë§ˆìŒì— ìƒì²˜ë§Œ ë‚¨ê²¼ìŠµë‹ˆë‹¤. ë”°ëŒë¦¼ì€ ë” êµë¬˜í•´ì¡Œê³ , ë¬¸ì œëŠ” ìˆ˜ë©´ ì•„ë˜ë¡œ ê°€ë¼ì•‰ì•„ í•´ê²°í•˜ê¸° ë”ìš± ì–´ë ¤ì›Œì¡ŒìŠµë‹ˆë‹¤.`,
                        'ì˜ì˜': `ì¼ë‹¨ ê¸‰í•œ ë¶ˆì€ ê»ì§€ë§Œ, ì•„ì´ë“¤ ì‚¬ì´ì˜ ì„œë¨¹í•œ ê³µê¸°ëŠ” ì—¬ì „í•©ë‹ˆë‹¤. ì§ì ‘ì ì¸ ê´´ë¡­í˜ì€ ì‚¬ë¼ì¡Œì§€ë§Œ, ë³´ì´ì§€ ì•ŠëŠ” ë²½ì´ ìƒê¸´ ê²ƒ ê°™ì•„ ë§ˆìŒì´ ë¬´ê²ìŠµë‹ˆë‹¤.`
                    }
                },
                {
                    id: `archaeologist`,
                    title: `ì „ì„¤ì˜ ìœ ë¬¼ê³¼ ë¬´ë„ˆì§€ëŠ” ìœ ì `,
                    description: `ì „ì„¤ ì† ìœ ë¬¼ì„ ì†ì— ë„£ì€ ìˆœê°„, ìœ ì ì´ ë¬´ë„ˆì§€ê¸° ì‹œì‘í•©ë‹ˆë‹¤! ëª©ìˆ¨ì´ëƒ, ì„¸ê¸°ì˜ ë°œê²¬ì´ëƒ, ì„ íƒì˜ ì‹œê°„ì…ë‹ˆë‹¤.`,
                    initialPrompt: `ë‹¹ì‹ ì€ ìíƒ€ê³µì¸ ìµœê³ ì˜ ê³ ê³ í•™ì, 'ì¸ë””ì•„ë‚˜' ì •. ë§ˆì¹¨ë‚´ ì•ˆë°ìŠ¤ ì‚°ë§¥ ê¹Šì€ ê³³ì—ì„œ ì „ì„¤ì˜ ìœ ë¬¼ 'íƒœì–‘ì˜ ëˆˆë¬¼'ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤! í•˜ì§€ë§Œ ìœ ë¬¼ì„ ì§‘ì–´ ë“  ìˆœê°„, ì‚¬ë°©ì´ í”ë“¤ë¦¬ë©° ìœ ì ì´ í†µì§¸ë¡œ ë¬´ë„ˆì§€ê¸° ì‹œì‘í•©ë‹ˆë‹¤. ë‹¹ì‹ ì€ ì–´ë–»ê²Œ í–‰ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`,
                    icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>`,
                    imageUrl: `https://images.unsplash.com/photo-1592488831370-fe3692a465a3?q=80&w=2073&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D`,
                    initialHints: [`ìœ ë¬¼ ëŒ€ì‹  ë¹„ìŠ·í•œ ë¬´ê²Œì˜ ëŒë©©ì´ë¥¼ ì˜¬ë ¤ë†“ëŠ”ë‹¤.`, `í•¨ì •ì´ ì—†ëŠ” ë‹¤ë¥¸ íƒˆì¶œ ê²½ë¡œë¥¼ ë¯¸ì¹œë“¯ì´ ì°¾ëŠ”ë‹¤.`],
                    endings: {
                        'í•´í”¼': `ì´ê²Œ ë°”ë¡œ ì£¼ì¸ê³µ! ë‹¹ì‹ ì€ ì˜í™”ì²˜ëŸ¼ í•¨ì •ì„ ëŒíŒŒí•˜ì—¬ 'íƒœì–‘ì˜ ëˆˆë¬¼'ì„ ì†ì— ë„£ê³  ë¬´ì‚¬íˆ íƒˆì¶œí–ˆìŠµë‹ˆë‹¤. ë‹¹ì‹ ì˜ ì´ë¦„ì€ ì—­ì‚¬ì™€ ì „ì„¤ì— ì˜ì›íˆ ê¸°ë¡ë  ê²ƒì…ë‹ˆë‹¤.`,
                        'ìƒˆë“œ': `ì„¸ê¸°ì˜ ë°œê²¬ì„ ëˆˆì•ì— ë‘ê³  ìš•ì‹¬ì´ ê³¼í–ˆìŠµë‹ˆë‹¤. ê²°êµ­ ë¬´ë„ˆì§€ëŠ” ìœ ì ê³¼ í•¨ê»˜, ë‹¹ì‹ ê³¼ 'íƒœì–‘ì˜ ëˆˆë¬¼'ì€ ë‹¤ì‹œ ì„¸ìƒì—ì„œ ìŠí˜€ì¡ŒìŠµë‹ˆë‹¤.`,
                        'ì˜ì˜': `ìœ ë¬¼ì„ ê°€ì§€ê³ ëŠ” ë‚˜ê°ˆ ìˆ˜ ì—†ë‹¤ëŠ” ê±¸ ê¹¨ë‹«ê³  ëˆˆë¬¼ì„ ë¨¸ê¸ˆê³  í›„í‡´í–ˆìŠµë‹ˆë‹¤. ëª©ìˆ¨ì€ ê±´ì¡Œì§€ë§Œ, 'íƒœì–‘ì˜ ëˆˆë¬¼'ì€ ë‹¤ì‹œ ì–´ë‘  ì†ì— ì ê²¼ìŠµë‹ˆë‹¤. ë°œê²¬ì€ ë¯¸ì™„ìœ¼ë¡œ ë‚¨ì•˜ìŠµë‹ˆë‹¤.`
                    }
                }
            ];

            // í•¨ìˆ˜ ì„ ì–¸
            function renderSelectionScreen() {
                scenarioList.innerHTML = '';
                scenarios.forEach((scenario, index) => {
                    const card = document.createElement('div');
                    card.className = 'start-button bg-white p-5 rounded-xl shadow-sm border border-gray-200 flex items-center space-x-4 cursor-pointer hover:shadow-lg hover:ring-2 hover:ring-blue-500 transition-all duration-300 transform hover:-translate-y-1 fade-in';
                    card.dataset.scenarioId = scenario.id;
                    card.style.animationDelay = `${index * 100}ms`;
                    card.innerHTML = `
                        <div class="flex-shrink-0 bg-gray-100 p-3 rounded-full">${scenario.icon}</div>
                        <div class="flex-grow">
                            <h3 class="text-lg font-bold text-gray-800">${scenario.title}</h3>
                            <p class="text-sm text-gray-500">${scenario.description}</p>
                        </div>
                        <div class="flex-shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                        </div>`;
                    scenarioList.appendChild(card);
                });
            }
            
            function startSimulation(scenarioId) {
                const scenario = scenarios.find(s => s.id === scenarioId);
                if (!scenario) return;

                currentScenario = scenario;
                isGameEnded = false; 
                selectionScreen.classList.add('fade-out');
                setTimeout(() => {
                    selectionScreen.classList.add('hidden');
                    selectionScreen.classList.remove('fade-out');
                    chatWindow.innerHTML = '';
                    conversationHistory = [];
                    currentHints = scenario.initialHints || [];
                    simulationTitle.textContent = scenario.title;
                    
                    simulationScreen.classList.remove('hidden');
                    simulationScreen.classList.add('flex', 'fade-in');

                    if (scenario.imageUrl) {
                        addImageMessage(scenario.imageUrl);
                    }
                    addMessage(scenario.initialPrompt);
                    conversationHistory.push({ role: "model", parts: [{ text: scenario.initialPrompt }] });
                    toggleInput(true, currentHints.length > 0, false);
                    messageInput.focus();
                }, 300);
            }
            
            function resetAndShowSelection() {
                simulationScreen.classList.add('fade-out');
                analysisScreen.classList.add('fade-out');
                
                setTimeout(() => {
                    simulationScreen.classList.add('hidden');
                    simulationScreen.classList.remove('flex', 'fade-out', 'fade-in');
                    analysisScreen.classList.add('hidden');
                    analysisScreen.classList.remove('flex', 'fade-out', 'fade-in');
                    selectionScreen.classList.remove('hidden');
                    selectionScreen.classList.add('fade-in');

                    messageInput.value = '';
                    isGameEnded = false; 
                    
                    // --- BUG FIX: ëª…ì‹œì ì¸ íŒíŠ¸ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™” ---
                    hintButtonsContainer.innerHTML = ''; 
                    
                    toggleInput(false, false, false); 

                    analysisDesc.innerHTML = '';
                    analysisSummary.textContent = '';
                    if (analysisChartInstance) {
                        analysisChartInstance.destroy();
                        analysisChartInstance = null;
                    }
                }, 300);
            }

            function addImageMessage(url) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex justify-center mb-4 message-bubble-in';
                wrapper.innerHTML = `<div class="w-full max-w-md rounded-xl overflow-hidden shadow-lg bg-gray-200"><img src="${url}" alt="ì‹œë‚˜ë¦¬ì˜¤ ì´ë¯¸ì§€" loading="lazy" class="w-full h-auto object-cover" onerror="this.style.display='none'; this.parentElement.innerHTML='<div class=&quot;p-4 text-center text-red-500&quot;>ì´ë¯¸ì§€ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';"></div>`;
                chatWindow.appendChild(wrapper);
                scrollToBottom();
            }
            
            function addMessage(text, isUser = false) {
                const wrapper = document.createElement('div');
                wrapper.className = `flex mb-4 message-bubble-in ${isUser ? 'justify-end' : 'justify-start'}`;
                wrapper.innerHTML = `<div class="rounded-2xl py-2.5 px-4 max-w-[85%] sm:max-w-[80%] break-words shadow-sm ${isUser ? 'bg-blue-600 text-white rounded-br-lg' : 'bg-gray-200 text-gray-800 rounded-bl-lg'}">${text.replace(/\n/g, '<br>')}</div>`;
                chatWindow.appendChild(wrapper);
                scrollToBottom();
            }
            
            function toggleLoadingIndicator(show) {
                let loadingEl = document.getElementById('loading-indicator');
                if (show) {
                    if (!loadingEl) {
                        loadingEl = document.createElement('div');
                        loadingEl.id = 'loading-indicator';
                        loadingEl.className = 'flex justify-start mb-4 message-bubble-in';
                        loadingEl.innerHTML = `<div class="rounded-2xl rounded-bl-lg py-2.5 px-4 bg-gray-200"><div class="loading-dots"><span>â—</span><span>â—</span><span>â—</span></div></div>`;
                        chatWindow.appendChild(loadingEl);
                        scrollToBottom();
                    }
                } else {
                    if (loadingEl) loadingEl.remove();
                }
            }
            
            function displayHintButtons() {
                hintButtonsContainer.innerHTML = '';
                if (!currentHints || currentHints.length === 0 || isGameEnded) return;

                currentHints.forEach(hint => {
                    const button = document.createElement('button');
                    button.type = 'button';
                    button.className = 'hint-button bg-gray-200 text-gray-700 text-sm px-3 py-1.5 rounded-full hover:bg-gray-300 transition-colors fade-in';
                    button.textContent = hint;
                    button.onclick = () => {
                        messageInput.value = hint;
                        messageInput.focus();
                        hintButtonsContainer.innerHTML = ''; 
                    };
                    hintButtonsContainer.appendChild(button);
                });
            }

            function addEndingMessage(text, type) {
                const typeInfo = {
                    'í•´í”¼': { icon: 'ğŸ‰', color: 'text-green-600', border: 'border-green-400' },
                    'ìƒˆë“œ': { icon: 'â˜ ï¸', color: 'text-red-600', border: 'border-red-400' },
                    'ì˜ì˜': { icon: 'âš–ï¸', color: 'text-gray-600', border: 'border-gray-400' }
                }[type] || { icon: 'â“', color: 'text-gray-600', border: 'border-gray-400' };
                
                const wrapper = document.createElement('div');
                wrapper.className = `ending-card-wrapper my-4 p-4 flex justify-center message-bubble-in`;
                wrapper.innerHTML = `
                    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-6 text-center border-t-8 ${typeInfo.border}">
                        <div class="text-6xl mb-4">${typeInfo.icon}</div>
                        <h2 class="text-3xl font-bold ${typeInfo.color} mb-3">ì‹œë‚˜ë¦¬ì˜¤ ì™„ë£Œ: ${type}</h2>
                        <p class="text-gray-700 text-lg mb-8">${text}</p>
                        <div class="space-y-2">
                            <button class="analysis-button w-full bg-blue-600 text-white py-3 rounded-xl font-semibold hover:bg-blue-700 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-600">ì„±í–¥ ë¶„ì„í•˜ê¸°</button>
                            <button class="restart-button w-full bg-gray-800 text-white py-3 rounded-xl font-semibold hover:bg-gray-900 transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-800">ìƒˆë¡œìš´ ì‹œë‚˜ë¦¬ì˜¤ ì‹œì‘í•˜ê¸°</button>
                        </div>
                    </div>`;

                wrapper.querySelector('.restart-button').addEventListener('click', resetAndShowSelection);
                wrapper.querySelector('.analysis-button').addEventListener('click', startAnalysis);
                
                chatWindow.appendChild(wrapper);
                scrollToBottom();
            }
            
            // --- BUG FIX: `toggleInput` í•¨ìˆ˜ì—ì„œ íŒíŠ¸ ì»¨í…Œì´ë„ˆë¥¼ ì§ì ‘ ì œì–´í•˜ëŠ” ë¡œì§ ì œê±° ---
            function toggleInput(mainInputEnabled, hintsAvailable, isLoading = false) {
                const isInputDisabled = !mainInputEnabled || isGameEnded;
                
                messageInput.disabled = isInputDisabled;
                submitButton.disabled = isInputDisabled;
                showHintsButton.disabled = !hintsAvailable || isGameEnded;

                // ì´ í•¨ìˆ˜ëŠ” ë” ì´ìƒ íŒíŠ¸ ë²„íŠ¼ì„ ì§ì ‘ ìˆ¨ê¸°ì§€ ì•ŠìŠµë‹ˆë‹¤.
                // if (isInputDisabled || !hintsAvailable) {
                //     hintButtonsContainer.innerHTML = '';
                // }
                
                if (isGameEnded) {
                    messageInput.placeholder = "ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.";
                } else if (isLoading) {
                    messageInput.placeholder = "ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...";
                } else {
                    messageInput.placeholder = "ì–´ë–»ê²Œ í–‰ë™í•˜ì‹œê² ìŠµë‹ˆê¹Œ?";
                }
            }

            async function getLlmResponse() {
                if (!API_KEY || API_KEY === "ì—¬ê¸°ì—_ë°œê¸‰ë°›ì€_API_í‚¤ë¥¼_ì…ë ¥í•˜ì„¸ìš”") { 
                    addMessage("ì˜¤ë¥˜: API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì˜ API_KEY ë³€ìˆ˜ì— ìì‹ ì˜ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”."); 
                    toggleInput(true, false, false);
                    return; 
                }
                
                // --- BUG FIX: ë¡œë”© ìƒíƒœ ì§„ì… ì‹œ í˜„ì¬ íŒíŠ¸ ìƒíƒœë¥¼ ìœ ì§€í•˜ë„ë¡ ìˆ˜ì • ---
                const hintsAreCurrentlyAvailable = currentHints.length > 0;
                toggleInput(false, hintsAreCurrentlyAvailable, true);
                toggleLoadingIndicator(true);
                
                try {
                    const response = await fetch(API_URL, { 
                        method: 'POST', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ 
                            systemInstruction: { role: "model", parts: [{ text: SYSTEM_PROMPT }] }, 
                            contents: conversationHistory 
                        }) 
                    });

                    toggleLoadingIndicator(false);

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API ì˜¤ë¥˜: ${response.status} - ${errorData.error?.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`);
                    }

                    const data = await response.json();
                    const llmText = data.candidates?.[0]?.content?.parts?.[0]?.text?.trim() || "ì˜¤ë¥˜: ì‘ë‹µì„ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                    
                    const endingMatch = llmText.match(/\[ì—”ë”©:(í•´í”¼|ìƒˆë“œ|ì˜ì˜)\]/);

                    if (endingMatch && currentScenario) {
                        const storyTextBeforeEnding = llmText.replace(endingMatch[0], '').trim();
                        const endingType = endingMatch[1];
                        const endingText = currentScenario.endings[endingType] || "ì‹œë‚˜ë¦¬ì˜¤ê°€ ë§ˆë¬´ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.";
                        
                        if (storyTextBeforeEnding) {
                            addMessage(storyTextBeforeEnding);
                            conversationHistory.push({ role: "model", parts: [{ text: storyTextBeforeEnding }] });
                        }

                        isGameEnded = true;
                        addEndingMessage(endingText, endingType);
                        toggleInput(false, false, false);
                        return;
                    }

                    const hintSplit = llmText.split('[íŒíŠ¸]');
                    const storyText = hintSplit[0].trim();
                    
                    if(storyText) {
                        addMessage(storyText);
                        conversationHistory.push({ role: "model", parts: [{ text: storyText }] });
                    }

                    let hintsAvailable = false;
                    currentHints = [];
                    if (hintSplit.length > 1) {
                        currentHints = hintSplit[1].trim().split(/\d\.\s*/).filter(Boolean).map(h => h.trim());
                        if (currentHints.length > 0) {
                            hintsAvailable = true;
                        }
                    }
                    
                    // --- BUG FIX: ìƒˆ íŒíŠ¸ê°€ ì—†ì„ ê²½ìš° ëª…ì‹œì ìœ¼ë¡œ íŒíŠ¸ ì»¨í…Œì´ë„ˆ ë¹„ìš°ê¸° ---
                    if (!hintsAvailable) {
                        hintButtonsContainer.innerHTML = '';
                    }

                    toggleInput(true, hintsAvailable, false);
                    messageInput.focus();

                } catch (error) {
                    toggleLoadingIndicator(false);
                    // ì—ëŸ¬ ë°œìƒ ì‹œ ì…ë ¥ì€ ë‹¤ì‹œ í™œì„±í™”í•˜ë˜, íŒíŠ¸ëŠ” ì—†ë‹¤ê³  ê°€ì •
                    toggleInput(true, false);
                    addMessage(`ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                }
            }
            
            function scrollToBottom() {
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function parseScores(text) {
                if (!text) return {};

                let jsonString = text.trim();

                // Handle markdown code blocks (e.g., ```json\n{...}\n```)
                const markdownMatch = jsonString.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
                if (markdownMatch && markdownMatch[1]) {
                    jsonString = markdownMatch[1].trim();
                }

                // Find the first '{' and the last '}' to extract the JSON object
                const jsonStartIndex = jsonString.indexOf('{');
                const jsonEndIndex = jsonString.lastIndexOf('}');

                if (jsonStartIndex !== -1 && jsonEndIndex > jsonStartIndex) {
                    jsonString = jsonString.substring(jsonStartIndex, jsonEndIndex + 1);
                }

                // Try to parse the cleaned string
                try {
                    // It might still fail if the content is not valid JSON
                    return JSON.parse(jsonString);
                } catch (e) {
                    console.error("Failed to parse extracted JSON:", e);
                    console.error("Original text received from API:", text);
                    return {}; // Return empty object on failure
                }
            }

            async function startAnalysis() {
                simulationScreen.classList.add('hidden');
                analysisScreen.classList.remove('hidden');
                analysisScreen.classList.add('flex', 'fade-in');
                analysisSummary.textContent = 'ë‹¹ì‹ ì˜ ì„±í–¥ì„ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...';
                analysisDesc.innerHTML = '';
                if (analysisChartInstance) {
                    analysisChartInstance.destroy();
                    analysisChartInstance = null;
                }

                if (!API_KEY || API_KEY.includes("ì—¬ê¸°ì—_ë°œê¸‰ë°›ì€_API_í‚¤ë¥¼_ì…ë ¥í•˜ì„¸ìš”")) {
                    renderAnalysis({}, "API í‚¤ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì˜ API_KEY ë³€ìˆ˜ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                    return;
                }

                const hasUserResponses = conversationHistory.some(h => h.role === 'user');
                if (!hasUserResponses) {
                    renderAnalysis({}, "í”Œë ˆì´ì–´ì˜ ì‘ë‹µ ê¸°ë¡ì´ ì—†ì–´ ë¶„ì„í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }

                const maxRetries = 2;
                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        const response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                systemInstruction: { role: 'model', parts: [{ text: ANALYSIS_PROMPT }] },
                                contents: conversationHistory,
                                safetySettings: [
                                    { category: 'HARM_CATEGORY_HARASSMENT', threshold: 'BLOCK_NONE' },
                                    { category: 'HARM_CATEGORY_HATE_SPEECH', threshold: 'BLOCK_NONE' },
                                    { category: 'HARM_CATEGORY_SEXUALLY_EXPLICIT', threshold: 'BLOCK_NONE' },
                                    { category: 'HARM_CATEGORY_DANGEROUS_CONTENT', threshold: 'BLOCK_NONE' }
                                ]
                            })
                        });

                        console.log("===== [1] API ì‘ë‹µ ìƒíƒœ =====");
                        console.log(`- ìƒíƒœ ì½”ë“œ (Status): ${response.status}`);
                        console.log(`- ìƒíƒœ ì •ìƒ ì—¬ë¶€ (OK): ${response.ok}`);

                        const responseData = await response.json();
                        console.log("===== [2] API ì‘ë‹µ ì „ì²´ ë°ì´í„° =====");
                        console.log(responseData);

                        if (!response.ok) {
                            throw new Error(`API ì„œë²„ê°€ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤. (ìƒíƒœ ì½”ë“œ: ${response.status})`);
                        }

                        if (!responseData.candidates || responseData.candidates.length === 0) {
                            console.error("APIê°€ ì •ìƒ ì‘ë‹µí–ˆì§€ë§Œ, ìƒì„±ëœ ê²°ê³¼(candidates)ê°€ ì—†ìŠµë‹ˆë‹¤. Safety Settingsì— ì˜í•´ ì°¨ë‹¨ë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                            // 'promptFeedback'ì´ ìˆë‹¤ë©´ ê·¸ ë‚´ìš©ë„ ì¶œë ¥
                            if (responseData.promptFeedback) {
                                console.log("ì°¨ë‹¨ ì›ì¸ (Prompt Feedback):", responseData.promptFeedback);
                            }
                            throw new Error("APIê°€ ë¶„ì„ ê²°ê³¼ë¥¼ ìƒì„±í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì‘ë‹µ ë°ì´í„°ì— 'candidates'ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        }

                        const jsonText = responseData.candidates[0]?.content?.parts[0]?.text || '[[ì‘ë‹µ í…ìŠ¤íŠ¸ ì—†ìŒ]]';
                        console.log("===== [3] AIê°€ ìƒì„±í•œ í…ìŠ¤íŠ¸ ì›ë³¸ =====");
                        console.log(jsonText);

                        const scores = parseScores(jsonText);
                        renderAnalysis(scores);
                        return; // ì„±ê³µí–ˆìœ¼ë¯€ë¡œ ë£¨í”„ ì¢…ë£Œ

                    } catch (e) {
                        console.error("!!!!! ì¹˜ëª…ì ì¸ ë¶„ì„ ì˜¤ë¥˜ ë°œìƒ !!!!!");
                        console.error(e);
                        if (attempt >= maxRetries) {
                            renderAnalysis({}, `ë¶„ì„ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${e.message}`);
                            return;
                        }
                    }
                }
            }

            function renderAnalysis(scores, errorMessage = null) {
                let finalScores = scores;
                let isFallback = false;

                const defaultTraitKeys = ['ë¶„ì„ë ¥', 'ì°½ì˜ì„±', 'ê²°ë‹¨ë ¥', 'ê³µê°ë ¥', 'ì‹ ì¤‘í•¨', 'ì£¼ë„ì„±'];
                const labels = Object.keys(scores);
                
                if (errorMessage || labels.length === 0 || !defaultTraitKeys.every(k => labels.includes(k)) || Object.values(scores).some(v => typeof v !== 'number' || isNaN(v))) {
                    isFallback = true;
                    let reason = 'ê²Œì„ í”Œë ˆì´ ê¸°ë¡ì´ ë¶€ì¡±í•˜ê±°ë‚˜ AI ì‘ë‹µì´ ë¶ˆì•ˆì •í•˜ì—¬ ë¶„ì„ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
                    if (errorMessage) {
                        reason = `ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${errorMessage}`;
                    }
                    analysisSummary.textContent = 'ë¶„ì„ ì‹¤íŒ¨: ê¸°ë³¸ ê²°ê³¼ í‘œì‹œ';
                    analysisDesc.innerHTML = `<li class="text-red-600 p-2 bg-red-50 rounded-md">${reason}</li>`;
                    
                    finalScores = {
                        'ë¶„ì„ë ¥': 5, 'ì°½ì˜ì„±': 5, 'ê²°ë‹¨ë ¥': 5,
                        'ê³µê°ë ¥': 5, 'ì‹ ì¤‘í•¨': 5, 'ì£¼ë„ì„±': 5
                    };
                }

                const finalLabels = Object.keys(finalScores);
                const values = Object.values(finalScores);
                
                if (!isFallback) {
                    const highestKey = finalLabels.reduce((a, b) => finalScores[a] > finalScores[b] ? a : b);
                    const summaryMap = {
                        'ë¶„ì„ë ¥': "ëª…ì„í•œ 'ë¶„ì„ê°€'",
                        'ì°½ì˜ì„±': "ë…ì°½ì ì¸ 'ì°½ì¡°ì'",
                        'ê²°ë‹¨ë ¥': "ê³¼ê°í•œ 'í–‰ë™ê°€'",
                        'ê³µê°ë ¥': "ë”°ëœ»í•œ 'ì¡°ë ¥ì'",
                        'ì‹ ì¤‘í•¨': "ì‹ ì¤‘í•œ 'ì „ëµê°€'",
                        'ì£¼ë„ì„±': "ëŒ€ë‹´í•œ 'ë¦¬ë”'"
                    };
                    analysisSummary.textContent = `ë‹¹ì‹ ì€ ${summaryMap[highestKey] || highestKey} ìœ í˜•ì˜ í•´ê²°ì‚¬ì…ë‹ˆë‹¤.`;
                    analysisDesc.innerHTML = finalLabels.map(k => `<li><strong class="text-indigo-600">${k}</strong>: ${TRAIT_DESCRIPTIONS[k] || 'ì„¤ëª…ì´ ì—†ìŠµë‹ˆë‹¤.'}</li>`).join('');
                }

                if (analysisChartInstance) {
                    analysisChartInstance.destroy();
                }
                analysisChartInstance = new Chart(analysisChartCanvas, {
                    type: 'radar',
                    data: {
                        labels: finalLabels,
                        datasets: [{
                            label: 'ì„±í–¥ ì ìˆ˜',
                            data: values,
                            backgroundColor: isFallback ? 'rgba(107, 114, 128, 0.2)' : 'rgba(99, 102, 241, 0.2)',
                            borderColor: isFallback ? 'rgba(107, 114, 128, 1)' : 'rgba(99, 102, 241, 1)',
                            pointBackgroundColor: isFallback ? 'rgba(107, 114, 128, 1)' : 'rgba(99, 102, 241, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: isFallback ? 'rgba(107, 114, 128, 1)' : 'rgba(99, 102, 241, 1)'
                        }]
                    },
                    options: { 
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: { 
                            r: { 
                                suggestedMin: 0, 
                                suggestedMax: 10,
                                grid: { color: 'rgba(0, 0, 0, 0.1)' },
                                angleLines: { color: 'rgba(0, 0, 0, 0.1)' },
                                pointLabels: { font: { size: 14 } }
                            } 
                        },
                        plugins: {
                            legend: {
                                display: false
                            }
                        }
                    }
                });
            }

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            scenarioList.addEventListener('click', (e) => { 
                const startButton = e.target.closest('.start-button'); 
                if (startButton) { 
                    startSimulation(startButton.dataset.scenarioId); 
                } 
            });

            messageForm.addEventListener('submit', (e) => { 
                e.preventDefault(); 
                const userInput = messageInput.value.trim(); 
                if (userInput && !messageInput.disabled) {
                    hintButtonsContainer.innerHTML = '';
                    addMessage(userInput, true); 
                    conversationHistory.push({ role: "user", parts: [{ text: userInput }] }); 
                    messageInput.value = ''; 
                    getLlmResponse(); 
                } 
            });

            showHintsButton.addEventListener('click', () => {
                displayHintButtons();
            });

            backButton.addEventListener('click', resetAndShowSelection);
            analysisBackButton.addEventListener('click', resetAndShowSelection);

            // ì´ˆê¸°í™”
            renderSelectionScreen(); 
            toggleInput(false, false); 

        } catch (error) {
            console.error("ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ì¤‘ ì¹˜ëª…ì ì¸ ì˜¤ë¥˜ ë°œìƒ:", error);
            document.body.innerHTML = `<div class="p-4 text-center text-red-600 bg-red-50 rounded-lg">
                <h2 class="text-xl font-bold mb-2">ëŸ°íƒ€ì„ ì˜¤ë¥˜ ë°œìƒ</h2>
                <p class="mb-4">ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ ì¤‘ ì‹¬ê°í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                <pre class="text-left bg-gray-100 p-2 rounded text-sm text-gray-700 whitespace-pre-wrap">${error.stack}</pre>
            </div>`;
        }
    });
</script>
</body>
</html>
